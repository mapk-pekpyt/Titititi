# plugins/say.py
import random
from plugins.common import get_name

# -------------------------
# 78 –∫–∞—Ä—Ç –¢–∞—Ä–æ —Å–æ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
# -------------------------
TAROT = [
    ("–®—É—Ç", "–Ω–æ–≤—ã–π –ø—É—Ç—å, —Å–≤–µ–∂–∏–π –≤–æ–∑–¥—É—Ö –ø–µ—Ä–µ–º–µ–Ω", "–ø–æ—Ç–µ—Ä—è –æ–ø–æ—Ä—ã, —Ö–∞–æ—Å, –∑–∞–±–ª—É–∂–¥–µ–Ω–∏–µ"),
    ("–ú–∞–≥", "–≤–æ–ª—è, –≤–ª–∏—è–Ω–∏–µ, —Å–∏–ª–∞", "–∫—Ä–∞—Ö –∑–∞–º—ã—Å–ª–∞, –æ–±–º–∞–Ω"),
    ("–ñ—Ä–∏—Ü–∞", "–∏–Ω—Ç—É–∏—Ü–∏—è, —Ç–∞–π–Ω—ã", "–æ—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è"),
    ("–ò–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞", "—Ä–æ—Å—Ç, –∑–∞–±–æ—Ç–∞", "–≤—ã–≥–æ—Ä–∞–Ω–∏–µ, –∑–∞—Å—Ç–æ–π"),
    ("–ò–º–ø–µ—Ä–∞—Ç–æ—Ä", "–∫–æ–Ω—Ç—Ä–æ–ª—å", "–∂—ë—Å—Ç–∫–æ—Å—Ç—å, –¥–∞–≤–ª–µ–Ω–∏–µ"),
    ("–ñ—Ä–µ—Ü", "—Å–æ–≤–µ—Ç, –Ω–∞—Å—Ç–∞–≤–ª–µ–Ω–∏–µ", "—Å–æ–º–Ω–µ–Ω–∏–µ, –ª–æ–∂–Ω—ã–π –ø—É—Ç—å"),
    ("–í–ª—é–±–ª—ë–Ω–Ω—ã–µ", "–≤—ã–±–æ—Ä —Å–µ—Ä–¥—Ü–∞", "—Ä–∞–∑—Ä—ã–≤, –æ–±–º–∞–Ω"),
    ("–ö–æ–ª–µ—Å–Ω–∏—Ü–∞", "—Ä—ã–≤–æ–∫, –ø–æ–±–µ–¥–∞", "–ø–æ—Ç–µ—Ä—è –∫–æ–Ω—Ç—Ä–æ–ª—è"),
    ("–°–∏–ª–∞", "—Å—Ç–æ–π–∫–æ—Å—Ç—å", "–ø–∞–Ω–∏–∫–∞"),
    ("–û—Ç—à–µ–ª—å–Ω–∏–∫", "–º—É–¥—Ä–æ—Å—Ç—å, –ø–æ–∏—Å–∫", "–æ–¥–∏–Ω–æ—á–µ—Å—Ç–≤–æ"),
    ("–ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω—ã", "—É–¥–∞—á–∞", "–Ω–µ—É–¥–∞—á–Ω—ã–π —Ü–∏–∫–ª"),
    ("–°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å", "–∫–∞—Ä–º–∞", "—Ä–∞—Å–ø–ª–∞—Ç–∞"),
    ("–ü–æ–≤–µ—à–µ–Ω–Ω—ã–π", "–æ–∑–∞—Ä–µ–Ω–∏–µ", "–∂–µ—Ä—Ç–≤–∞ –Ω–∞–ø—Ä–∞—Å–Ω–æ"),
    ("–°–º–µ—Ä—Ç—å", "–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ", "—Å—Ç—Ä–∞—Ö –ø–µ—Ä–µ–º–µ–Ω"),
    ("–£–º–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å", "–±–∞–ª–∞–Ω—Å", "–¥–∏—Å–±–∞–ª–∞–Ω—Å"),
    ("–î—å—è–≤–æ–ª", "—Å—Ç—Ä–∞—Å—Ç—å, –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å", "—Ä–∞–∑—Ä—É—à–µ–Ω–∏–µ"),
    ("–ë–∞—à–Ω—è", "–ø–æ—Ç—Ä—è—Å–µ–Ω–∏–µ", "–ª–æ–º–∫–∞ –ø—Ä–∏–≤—ã—á–Ω–æ–≥–æ"),
    ("–ó–≤–µ–∑–¥–∞", "–Ω–∞–¥–µ–∂–¥–∞", "—É—Å—Ç–∞–ª–æ—Å—Ç—å"),
    ("–õ—É–Ω–∞", "–∏–ª–ª—é–∑–∏—è", "—Ç—è–∂—ë–ª–æ–µ –ø—Ä–æ—è—Å–Ω–µ–Ω–∏–µ"),
    ("–°–æ–ª–Ω—Ü–µ", "—Ä–∞–¥–æ—Å—Ç—å, —è—Å–Ω–æ—Å—Ç—å", "–ª–æ–∂–Ω–æ–µ —Å—á–∞—Å—Ç—å–µ"),
    ("–°—É–¥", "–ø–µ—Ä–µ—Ä–æ–∂–¥–µ–Ω–∏–µ", "–æ—à–∏–±–æ—á–Ω—ã–π –ø—É—Ç—å"),
    ("–ú–∏—Ä", "–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ", "—Ü–∏–∫–ª –Ω–µ –∑–∞–∫—Ä—ã—Ç")
]

# –º–∞—Å—Ç–∏
for suit, pos, neg in [
    ("–ñ–µ–∑–ª–æ–≤", "—ç–Ω–µ—Ä–≥–∏—è, —Å—Ç—Ä–∞—Å—Ç—å", "–∏—Å—Ç–æ—â–µ–Ω–∏–µ"),
    ("–ö—É–±–∫–æ–≤", "—á—É–≤—Å—Ç–≤–∞, —ç–º–æ—Ü–∏–∏", "–æ–ø—É—Å—Ç–æ—à–µ–Ω–∏–µ"),
    ("–ú–µ—á–µ–π", "—É–º, –±–æ—Ä—å–±–∞", "—Ç—Ä–µ–≤–æ–≥–∞"),
    ("–ü–µ–Ω—Ç–∞–∫–ª–µ–π", "–º–∞—Ç–µ—Ä–∏—è, —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å", "–ø–æ—Ç–µ—Ä–∏")
]:
    for i in range(1, 11):
        TAROT.append((f"{i} {suit}", pos, neg))
    TAROT.extend([
        (f"–ü–∞–∂ {suit}", "–Ω–æ–≤–æ—Å—Ç–∏", "–Ω–µ–∑—Ä–µ–ª–æ—Å—Ç—å"),
        (f"–†—ã—Ü–∞—Ä—å {suit}", "–¥–≤–∏–∂–µ–Ω–∏–µ", "—Ö–∞–æ—Å"),
        (f"–ö–æ—Ä–æ–ª–µ–≤–∞ {suit}", "–º—É–¥—Ä–æ—Å—Ç—å", "–∫–æ–Ω—Ç—Ä–æ–ª—å —ç–º–æ—Ü–∏–π"),
        (f"–ö–æ—Ä–æ–ª—å {suit}", "–≤–ª–∞—Å—Ç—å", "–∂–µ—Å—Ç–∫–æ—Å—Ç—å"),
    ])


def draw_card():
    name, pos, neg = random.choice(TAROT)
    reversed_ = random.choice([True, False])
    meaning = neg if reversed_ else pos
    return {"name": name, "reversed": reversed_, "meaning": meaning}


# ---------------------------
# ------- –°–¢–ò–õ–ò ----------
# ---------------------------

# 1) –º—è–≥–∫–∏–π —Å—Ç–∏–ª—å
def style_soft(cards, name):
    text = f"‚ú® {name}, —è –≤–∏–∂—É –º—è–≥–∫–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ —ç–Ω–µ—Ä–≥–∏–π –≤–æ–∫—Ä—É–≥ —Ç–µ–±—è‚Ä¶\n\n"
    for i, c in enumerate(cards, 1):
        text += f"üîπ **{c['name']}** {'(–ø–µ—Ä–µ–≤—ë—Ä–Ω—É—Ç–∞—è)' if c['reversed'] else ''}\n"
        text += f"‚Üí {c['meaning']}\n\n"
    text += "üåø –ò—Ç–æ–≥: –ø—É—Ç—å –æ—Ç–∫—Ä—ã—Ç, –≥–ª–∞–≤–Ω–æ–µ ‚Äî —Å–¥–µ–ª–∞–π —à–∞–≥."
    return text


# 2) —Ç—ë–º–Ω—ã–π, –∂–µ—Å—Ç–∫–∏–π, –Ω–æ –±–µ–∑ –∂–µ—Å—Ç–∏
def style_dark(cards, name):
    text = f"üåí {name}, –∫–∞—Ä—Ç—ã —Å–µ–≥–æ–¥–Ω—è –Ω–µ –∂–µ–ª–∞—é—Ç –º–æ–ª—á–∞—Ç—å‚Ä¶\n\n"
    for i, c in enumerate(cards, 1):
        text += f"‚ö´ **{c['name']}** {'(–ø–µ—Ä–µ–≤—ë—Ä–Ω—É—Ç–∞—è)' if c['reversed'] else ''}\n"
        text += f"‚Üí {c['meaning']}\n\n"
    text += "‚ö†Ô∏è –°—É–¥—å–±–∞ —Ç—Ä–µ–±—É–µ—Ç –≤—ã–±–æ—Ä–∞. –¢—ã –Ω–µ —Å–º–æ–∂–µ—à—å —É–∫–ª–æ–Ω–∏—Ç—å—Å—è."
    return text


# 3) –≤–µ–¥—å–º–∞ (–∂—ë—Å—Ç–∫–æ, –º—Ä–∞—á–Ω–æ, –∞—Ç–º–æ—Å—Ñ–µ—Ä–Ω–æ)
def style_witch(cards, name):
    openers = [
        "üïØ –í–µ–¥—å–º–∞ –ø–æ–¥–Ω–∏–º–∞–µ—Ç –≥–ª–∞–∑–∞ –∏–∑-–ø–æ–¥ –∫–∞–ø—é—à–æ–Ω–∞‚Ä¶ ",
        "üï∏ –¢—É–º–∞–Ω —Ä–∞—Å—Å—Ç—É–ø–∞–µ—Ç—Å—è, –∏ —è –≤–∏–∂—É —Ç–≤–æ—é –Ω–∏—Ç—å —Å—É–¥—å–±—ã‚Ä¶ ",
        "üåë –¢–µ–Ω–∏ –ø–µ—Ä–µ—à—ë–ø—Ç—ã–≤–∞—é—Ç—Å—è –æ–±–æ –º–Ω–µ, ",
        "üíÄ –ó–µ—Ä–∫–∞–ª–æ —Ç—Ä–µ—Å–Ω—É–ª–æ, –∫–æ–≥–¥–∞ —è –ø—Ä–æ–∏–∑–Ω–µ—Å–ª–∞ —Ç–≤–æ—ë –∏–º—è‚Ä¶ ",
        "üî• –ö–æ—Å—Ç—ë—Ä –ø–æ–∫–∞–∑–∞–ª –≤–∏–¥–µ–Ω–∏–µ, "
    ]
    text = random.choice(openers) + f"{name}‚Ä¶\n\n"

    for c in cards:
        mark = random.choice(["üïØ", "ü©∏", "üï∏", "üíÄ", "üî•"])
        text += f"{mark} **{c['name']}** {'(–ø–µ—Ä–µ–≤—ë—Ä–Ω—É—Ç–∞—è)' if c['reversed'] else ''}\n"
        text += f"‚Üí {c['meaning']}\n\n"

    endings = [
        "ü©∏ –î–æ—Ä–æ–≥–∞ –≤–ø–µ—Ä–µ–¥–∏ —Ö–∏—â–Ω–∞—è. –ù–æ –æ–Ω–∞ –∂–¥—ë—Ç —Ç–µ–±—è.",
        "üî• –¢–æ, —á—Ç–æ –≥—Ä—è–¥—ë—Ç, –Ω–µ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å.",
        "üåë –ü—Ä–∏–≥–æ—Ç–æ–≤—å—Å—è ‚Äî –Ω–æ—á—å —Ö–æ—á–µ—Ç –∏—Å–ø—ã—Ç–∞—Ç—å —Ç–µ–±—è.",
        "üíÄ –¶–µ–Ω–∞ –±—É–¥–µ—Ç –≤–∑—è—Ç–∞. –ù–æ —Ç—ã –≤—ã–¥–µ—Ä–∂–∏—à—å.",
    ]
    text += random.choice(endings)
    return text


# 4) –¥–µ–º–æ–Ω–∏—á–µ—Å–∫–∏–π —Å—Ç–∏–ª—å (—Ö–æ–ª–æ–¥–Ω—ã–π, –±–µ—Å–ø–æ—â–∞–¥–Ω—ã–π)
def style_demon(cards, name):
    text = f"üòà –ì–æ–ª–æ—Å –∏–∑ –ø—É—Å—Ç–æ—Ç—ã –ø—Ä–æ–∏–∑–Ω–æ—Å–∏—Ç —Ç–≤–æ—ë –∏–º—è, {name}‚Ä¶\n"
    text += "¬´–¢—ã –∏—â–µ—à—å –∏—Å—Ç–∏–Ω—É? –•–æ—Ä–æ—à–æ. –Ø –ø–æ–∫–∞–∂—É –µ—ë¬ª. \n\n"

    for c in cards:
        text += f"üî• **{c['name']}** {'(–ø–µ—Ä–µ–≤—ë—Ä–Ω—É—Ç–∞—è)' if c['reversed'] else ''}\n"
        text += f"‚Üí {c['meaning']}\n\n"

    text += "üòà –ò—Ç–æ–≥: –¢–≤–æ—è —Å—É–¥—å–±–∞ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è —Å–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä–æ. –¢—ã —Å–º–æ–∂–µ—à—å —É–¥–µ—Ä–∂–∞—Ç—å—Å—è ‚Äî –∏–ª–∏ —Å–æ—Ä–≤—ë—à—å—Å—è."
    return text


# 5) –ª–µ—Å–Ω–∞—è –ø—Ä–æ—Ä–æ—á–∏—Ü–∞ (—Å–ª–∞–≤—è–Ω—Å–∫–∞—è, –¥—Ä–µ–≤–Ω—è—è)
def style_forest(cards, name):
    text = f"üå≤ –°—Ç–∞—Ä—É—Ö–∞ –≤ –ª–µ—Å—É —à–µ–ø—á–µ—Ç —Ç–≤–æ—ë –∏–º—è, {name}‚Ä¶\n"
    text += "¬´–°—É–¥—å–±–∞ —Ç–≤–æ—è –ø–µ—Ç–ª—è–µ—Ç, –∫–∞–∫ —Ç—Ä–æ–ø–∞ –º–µ–∂ —Å–æ—Å–µ–Ω‚Ä¶¬ª\n\n"

    for c in cards:
        mark = random.choice(["üçÇ", "üå≤", "üê∫", "üå´", "üî•"])
        text += f"{mark} **{c['name']}** {'(–ø–µ—Ä–µ–≤—ë—Ä–Ω—É—Ç–∞—è)' if c['reversed'] else ''}\n"
        text += f"‚Üí {c['meaning']}\n\n"

    text += "üå´ –ò—Ç–æ–≥: —Ç–æ, —á—Ç–æ –Ω–∞–π–¥—ë—à—å ‚Äî –±—ã–ª–æ —Ç–≤–æ–∏–º –≤—Å–µ–≥–¥–∞."
    return text


# 6) –ö–µ–ª—å—Ç—Å–∫–∏–π –∫—Ä–µ—Å—Ç ‚Äî –µ—Å–ª–∏ –∏–º–µ–Ω–Ω–æ 10 –∫–∞—Ä—Ç
positions = [
    "–°—É—Ç—å —Å–∏—Ç—É–∞—Ü–∏–∏",
    "–¢–æ, —á—Ç–æ –º–µ—à–∞–µ—Ç",
    "–ö–æ—Ä–Ω–∏ –ø—Ä–æ–±–ª–µ–º—ã",
    "–ù–µ–¥–∞–≤–Ω–µ–µ –ø—Ä–æ—à–ª–æ–µ",
    "–ë–ª–∏–∂–∞–π—à–µ–µ –±—É–¥—É—â–µ–µ",
    "–°–æ–∑–Ω–∞–Ω–∏–µ",
    "–ü–æ–¥—Å–æ–∑–Ω–∞–Ω–∏–µ",
    "–í–ª–∏—è–Ω–∏–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è",
    "–°—Ç—Ä–∞—Ö–∏ –∏ –∂–µ–ª–∞–Ω–∏—è",
    "–ò—Ç–æ–≥ –ø—É—Ç–∏"
]

def style_celtic(cards, name):
    text = f"üåÄ –ö–µ–ª—å—Ç—Å–∫–∏–π –ö—Ä–µ—Å—Ç –¥–ª—è {name}:\n\n"
    for i, c in enumerate(cards):
        text += f"üîπ **{positions[i]} ‚Äî {c['name']}** {'(–ø–µ—Ä–µ–≤—ë—Ä–Ω—É—Ç–∞—è)' if c['reversed'] else ''}\n"
        text += f"‚Üí {c['meaning']}\n\n"
    text += "üîÆ –ò—Ç–æ–≥: –°—É–¥—å–±–∞ –≤—ã–ª–æ–∂–∏–ª–∞ –≤—Å—ë –æ—Ç–∫—Ä—ã—Ç—ã–º —Ç–µ–∫—Å—Ç–æ–º. –†–µ—à–µ–Ω–∏–µ ‚Äî –∑–∞ —Ç–æ–±–æ–π."
    return text


# ---------------------------
# ------- –û–°–ù–û–í–ù–û–ô HANDLE ---
# ---------------------------
def handle(bot, message):
    text = (message.text or "")
    parts = text.split()

    # –∏–º—è: –µ—Å–ª–∏ –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ ‚Äî –≥–∞–¥–∞–Ω–∏–µ –¥–µ–ª–∞–µ—Ç –ü–û –¢–û–ú–£, –∫–æ–º—É –æ—Ç–≤–µ—á–∞–µ–º
    target = message.reply_to_message.from_user if message.reply_to_message else message.from_user
    name = get_name(target)

    # –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ä—Ç
    if len(parts) >= 2:
        try:
            count = int(parts[1])
            if count not in (3, 5, 7, 10):
                count = 3
        except:
            count = 3
    else:
        count = 3

    cards = [draw_card() for _ in range(count)]

    # –≤—ã–±–æ—Ä —Å—Ç–∏–ª—è
    if count == 10:
        text = style_celtic(cards, name)
    else:
        text = random.choice([
            style_soft,
            style_dark,
            style_witch,
            style_demon,
            style_forest
        ])(cards, name)

    bot.reply_to(message, text)