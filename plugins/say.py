# plugins/say.py
import random
import threading
from telebot.types import Message

TRIGGER = "/say"

ALL_CARDS = [
    # –°—Ç–∞—Ä—à–∏–µ –ê—Ä–∫–∞–Ω—ã
    "–î—É—Ä–∞–∫", "–ú–∞–≥", "–ñ—Ä–∏—Ü–∞", "–ò–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞", "–ò–º–ø–µ—Ä–∞—Ç–æ—Ä", "–ò–µ—Ä–æ—Ñ–∞–Ω—Ç", "–í–ª—é–±–ª–µ–Ω–Ω—ã–µ", "–ö–æ–ª–µ—Å–Ω–∏—Ü–∞",
    "–°–∏–ª–∞", "–û—Ç—à–µ–ª—å–Ω–∏–∫", "–ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω—ã", "–°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å", "–ü–æ–≤–µ—à–µ–Ω–Ω—ã–π", "–°–º–µ—Ä—Ç—å",
    "–£–º–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å", "–î—å—è–≤–æ–ª", "–ë–∞—à–Ω—è", "–ó–≤–µ–∑–¥–∞", "–õ—É–Ω–∞", "–°–æ–ª–Ω—Ü–µ", "–°—É–¥", "–ú–∏—Ä",
    # –ú–ª–∞–¥—à–∏–µ –ê—Ä–∫–∞–Ω—ã ‚Äî –ö—É–±–∫–∏
    "–¢—É–∑ –ö—É–±–∫–æ–≤", "–î–≤–æ–π–∫–∞ –ö—É–±–∫–æ–≤", "–¢—Ä–æ–π–∫–∞ –ö—É–±–∫–æ–≤", "–ß–µ—Ç–≤–µ—Ä–∫–∞ –ö—É–±–∫–æ–≤", "–ü—è—Ç–µ—Ä–∫–∞ –ö—É–±–∫–æ–≤", 
    "–®–µ—Å—Ç–µ—Ä–∫–∞ –ö—É–±–∫–æ–≤", "–°–µ–º–µ—Ä–∫–∞ –ö—É–±–∫–æ–≤", "–í–æ—Å—å–º–µ—Ä–∫–∞ –ö—É–±–∫–æ–≤", "–î–µ–≤—è—Ç–∫–∞ –ö—É–±–∫–æ–≤", "–î–µ—Å—è—Ç–∫–∞ –ö—É–±–∫–æ–≤",
    "–ü–∞–∂ –ö—É–±–∫–æ–≤", "–†—ã—Ü–∞—Ä—å –ö—É–±–∫–æ–≤", "–ö–æ—Ä–æ–ª–µ–≤–∞ –ö—É–±–∫–æ–≤", "–ö–æ—Ä–æ–ª—å –ö—É–±–∫–æ–≤",
    # –ú–µ—á–∏
    "–¢—É–∑ –ú–µ—á–µ–π", "–î–≤–æ–π–∫–∞ –ú–µ—á–µ–π", "–¢—Ä–æ–π–∫–∞ –ú–µ—á–µ–π", "–ß–µ—Ç–≤–µ—Ä–∫–∞ –ú–µ—á–µ–π", "–ü—è—Ç–µ—Ä–∫–∞ –ú–µ—á–µ–π", 
    "–®–µ—Å—Ç–µ—Ä–∫–∞ –ú–µ—á–µ–π", "–°–µ–º–µ—Ä–∫–∞ –ú–µ—á–µ–π", "–í–æ—Å—å–º–µ—Ä–∫–∞ –ú–µ—á–µ–π", "–î–µ–≤—è—Ç–∫–∞ –ú–µ—á–µ–π", "–î–µ—Å—è—Ç–∫–∞ –ú–µ—á–µ–π",
    "–ü–∞–∂ –ú–µ—á–µ–π", "–†—ã—Ü–∞—Ä—å –ú–µ—á–µ–π", "–ö–æ—Ä–æ–ª–µ–≤–∞ –ú–µ—á–µ–π", "–ö–æ—Ä–æ–ª—å –ú–µ—á–µ–π",
    # –ü–µ–Ω—Ç–∞–∫–ª–∏
    "–¢—É–∑ –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "–î–≤–æ–π–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "–¢—Ä–æ–π–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "–ß–µ—Ç–≤–µ—Ä–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "–ü—è—Ç–µ—Ä–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π",
    "–®–µ—Å—Ç–µ—Ä–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "–°–µ–º–µ—Ä–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "–í–æ—Å—å–º–µ—Ä–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "–î–µ–≤—è—Ç–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "–î–µ—Å—è—Ç–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π",
    "–ü–∞–∂ –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "–†—ã—Ü–∞—Ä—å –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "–ö–æ—Ä–æ–ª–µ–≤–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "–ö–æ—Ä–æ–ª—å –ü–µ–Ω—Ç–∞–∫–ª–µ–π",
    # –ñ–µ–∑–ª—ã
    "–¢—É–∑ –ñ–µ–∑–ª–æ–≤", "–î–≤–æ–π–∫–∞ –ñ–µ–∑–ª–æ–≤", "–¢—Ä–æ–π–∫–∞ –ñ–µ–∑–ª–æ–≤", "–ß–µ—Ç–≤–µ—Ä–∫–∞ –ñ–µ–∑–ª–æ–≤", "–ü—è—Ç–µ—Ä–∫–∞ –ñ–µ–∑–ª–æ–≤",
    "–®–µ—Å—Ç–µ—Ä–∫–∞ –ñ–µ–∑–ª–æ–≤", "–°–µ–º–µ—Ä–∫–∞ –ñ–µ–∑–ª–æ–≤", "–í–æ—Å—å–º–µ—Ä–∫–∞ –ñ–µ–∑–ª–æ–≤", "–î–µ–≤—è—Ç–∫–∞ –ñ–µ–∑–ª–æ–≤", "–î–µ—Å—è—Ç–∫–∞ –ñ–µ–∑–ª–æ–≤",
    "–ü–∞–∂ –ñ–µ–∑–ª–æ–≤", "–†—ã—Ü–∞—Ä—å –ñ–µ–∑–ª–æ–≤", "–ö–æ—Ä–æ–ª–µ–≤–∞ –ñ–µ–∑–ª–æ–≤", "–ö–æ—Ä–æ–ª—å –ñ–µ–∑–ª–æ–≤",
]

CARD_EMOJIS = ["üîÆ", "‚ú®", "üåô", "üî•", "üïØÔ∏è", "üíÄ", "üåü", "üí´", "‚ö°", "üí∞", "üå™Ô∏è", "üåä", "üå∏", "üçÄ", "üåà", "ü¶ã", "üåπ"]

INTRO_PHRASES = [
    "üîÆ –Ø –≤–∏–∂—É, {name}‚Ä¶",
    "‚ú® –ö–∞—Ä—Ç—ã —à–µ–ø—á—É—Ç —Ç–µ–±–µ, {name}‚Ä¶",
    "üåô –°—É–¥—å–±–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø–µ—Ä–µ–¥ —Ç–æ–±–æ–π –ø—É—Ç—å, {name}‚Ä¶",
    "üî• –ú–∞–≥–∏—á–µ—Å–∫–∏–π —Ä–∞—Å–∫–ª–∞–¥ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, {name}‚Ä¶",
    "üïØÔ∏è –í–∏—Ö—Ä—å —ç–Ω–µ—Ä–≥–∏–∏ –ø—Ä–∏–Ω–æ—Å–∏—Ç –ø–æ—Å–ª–∞–Ω–∏–µ, {name}‚Ä¶",
]

CURSE_CARDS = [
    "–ü–æ—Ä—á–∞: –°–≥–ª–∞–∑ üíÄ", "–ü–æ—Ä—á–∞: –ë–æ–ª–µ–∑–Ω—å üï∑Ô∏è", "–ü–æ—Ä—á–∞: –ù–µ–≤–µ–∑–µ–Ω–∏–µ üå™Ô∏è", "–ü–æ—Ä—á–∞: –†–∞–∑–ª–∞–¥ üî•", "–ü–æ—Ä—á–∞: –°—Å–æ—Ä–∞ ‚ö°"
]

# –î–ª—è –∫–∞–∂–¥–æ–π –∫–∞—Ä—Ç—ã 3-4 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è
CARD_MEANINGS = {
    "–°–æ–ª–Ω—Ü–µ": [
        "–°–æ–ª–Ω—Ü–µ —Å–∏—è–µ—Ç —è—Ä–∫–æ üåû, —É–¥–∞—á–∞ –Ω–∞ —Ç–≤–æ–µ–π —Å—Ç–æ—Ä–æ–Ω–µ, —É—Å–ø–µ—Ö –ø—Ä–∏–¥–µ—Ç –≤ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ö üí∞.",
        "–°–∏—è–Ω–∏–µ –°–æ–ª–Ω—Ü–∞ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —è—Å–Ω–æ—Å—Ç—å –º—ã—Å–ª–∏ –∏ –≥–∞—Ä–º–æ–Ω–∏—é, –±—É–¥—å —É–≤–µ—Ä–µ–Ω –≤ —Å–≤–æ–∏—Ö —Ä–µ—à–µ–Ω–∏—è—Ö üåü.",
        "–°–æ–ª–Ω—Ü–µ –ø—Ä–∏–Ω–æ—Å–∏—Ç —Ä–∞–¥–æ—Å—Ç—å –∏ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–∏–µ, —Ñ–∏–Ω–∞–Ω—Å—ã –∏ –∑–¥–æ—Ä–æ–≤—å–µ –±—É–¥—É—Ç —Ä–∞–¥–æ–≤–∞—Ç—å üåà."
    ],
    "–ë–∞—à–Ω—è": [
        "–ë–∞—à–Ω—è —Ä—É—à–∏—Ç—Å—è ‚ö°, —Å—Ç–∞—Ä—ã–µ –ø–ª–∞–Ω—ã —Ä–∞–∑—Ä—É—à–∞—é—Ç—Å—è, –±—É–¥—å –æ—Å—Ç–æ—Ä–æ–∂–µ–Ω, –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω—ã –≤–æ–∑–º–æ–∂–Ω—ã.",
        "–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –æ–±—Ä—É—à–∞—Ç—Å—è –∫–∞–∫ –º–æ–ª–Ω–∏—è, —Å–æ—Ö—Ä–∞–Ω—è–π —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ üïØÔ∏è.",
        "–¢–≤–æ–∏ —Ç–µ–∫—É—â–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –º–æ–≥—É—Ç –ø–æ—Å—Ç—Ä–∞–¥–∞—Ç—å, –±—É–¥—å –≥–æ—Ç–æ–≤ –∫ —Ç—Ä—É–¥–Ω–æ—Å—Ç—è–º üî•."
    ],
    "–ü–æ–≤–µ—à–µ–Ω–Ω—ã–π": [
        "–ü–æ–≤–µ—à–µ–Ω–Ω—ã–π –Ω–∞–ø–æ–º–∏–Ω–∞–µ—Ç –æ –ø–∞—É–∑–µ, —Å–µ–π—á–∞—Å –ª—É—á—à–µ –Ω–∞–±–ª—é–¥–∞—Ç—å, –∞ –Ω–µ –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å üåô.",
        "–¢–µ—Ä–ø–µ–Ω–∏–µ –∏ –ø–æ–Ω–∏–º–∞–Ω–∏–µ ‚Äî —Ç–≤–æ–∏ —Å–æ—é–∑–Ω–∏–∫–∏, –≤—Ä–µ–º—è –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–∏—Å—Ö–æ–¥—è—â–µ–µ üåÄ.",
        "–°–º–∏—Ä–µ–Ω–∏–µ –∏ –æ–∂–∏–¥–∞–Ω–∏–µ –ø—Ä–∏–Ω–µ—Å—É—Ç –Ω–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏, –Ω–µ —Å–ø–µ—à–∏ ‚ö°."
    ],
    "–¢—É–∑ –ñ–µ–∑–ª–æ–≤": [
        "–ú–æ—â–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è –Ω–æ–≤–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞ üî•, –¥–µ–π—Å—Ç–≤—É–π —Ä–µ—à–∏—Ç–µ–ª—å–Ω–æ, –Ω–æ –æ–±–¥—É–º–∞–Ω–Ω–æ.",
        "–ù–∞—á–∞–ª–æ –Ω–æ–≤–æ–≥–æ –ø—É—Ç–∏, –∞–º–±–∏—Ü–∏–∏ –±—É–¥—É—Ç –ø–æ–¥–¥–µ—Ä–∂–∞–Ω—ã –í—Å–µ–ª–µ–Ω–Ω–æ–π üåü.",
        "–¢—É–∑ –ñ–µ–∑–ª–æ–≤ –≤–¥–æ—Ö–Ω–æ–≤–ª—è–µ—Ç –Ω–∞ –Ω–æ–≤—ã–µ –∏–¥–µ–∏ –∏ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—É, –¥–µ–π—Å—Ç–≤—É–π —Å–º–µ–ª–æ üåà."
    ],
    "–î–µ–≤—è—Ç–∫–∞ –ö—É–±–∫–æ–≤": [
        "–†–∞–¥–æ—Å—Ç—å –∏ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–∏–µ üéâ, –Ω–∞—Å–ª–∞–∂–¥–∞–π—Å—è –¥–æ—Å—Ç–∏–≥–Ω—É—Ç—ã–º –∏ –¥–µ–ª–∏—Å—å —Å –±–ª–∏–∑–∫–∏–º–∏.",
        "–°–æ–±—ã—Ç–∏—è –ø–æ—Ä–∞–¥—É—é—Ç, –Ω–æ –ø–æ–º–Ω–∏ –æ –±–∞–ª–∞–Ω—Å–µ üí´.",
        "–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –∂–µ–ª–∞–Ω–∏–π –∏ —É—Å–ø–µ—Ö –≤ –ª–∏—á–Ω—ã—Ö –¥–µ–ª–∞—Ö, –Ω–µ —Ç–µ—Ä—è–π –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—é üå∏."
    ],
    # –î–æ–±–∞–≤—å –≤—Å–µ –∫–∞—Ä—Ç—ã –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ —Å 3-4 –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è–º–∏ –∫–∞–∂–¥–∞—è
}

def get_name(message: Message):
    if message.from_user.first_name:
        return message.from_user.first_name
    return "—Ç—ã"

def generate_prediction(name, n=3, curse=False):
    n = max(1, min(n, 10))
    prediction_lines = []

    if curse:
        card = random.choice(CURSE_CARDS)
        prediction_lines.append(f"üíÄ –í–Ω–∏–º–∞–Ω–∏–µ! {card} –Ω–∞–≤–µ–ª–∏ –Ω–∞ —Ç–µ–±—è. –ë–µ—Ä–µ–≥–∏ —Å–µ–±—è!")
        return prediction_lines

    cards = random.sample(ALL_CARDS, n)
    used_emojis = []

    for card in cards:
        meanings = CARD_MEANINGS.get(card, [f"–ö–∞—Ä—Ç–∞ {card} –Ω–µ—Å—ë—Ç —Ç–∞–π–Ω—ã–µ –∑–Ω–∞–Ω–∏—è üåÄ."])
        text = random.choice(meanings)
        emoji = random.choice([e for e in CARD_EMOJIS if e not in used_emojis])
        used_emojis.append(emoji)
        prediction_lines.append(f"{emoji} {text}")

    # –ü–æ–¥—ã—Ç–æ–≥ —Å–æ–∑–¥–∞–µ–º –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—ã–ø–∞–≤—à–∏—Ö –∫–∞—Ä—Ç
    summary_phrases = []
    for card in cards:
        summary_phrases.extend(CARD_MEANINGS.get(card, []))
    summary_text = " ".join(random.sample(summary_phrases, min(3, len(summary_phrases))))
    prediction_lines.append(f"üîÆ –ü–æ–¥–≤–æ–¥—è –∏—Ç–æ–≥, –≤–∏–∂—É: {summary_text}")

    return prediction_lines

def handle(bot, message: Message):
    text = (message.text or "").strip().lower()
    if not text.startswith(TRIGGER):
        return

    parts = text.split()
    n = 3
    curse = False
    for part in parts[1:]:
        if part.isdigit():
            n = int(part)
        elif "–ø–æ—Ä—á–∞" in part:
            curse = True

    name = get_name(message)
    intro = random.choice(INTRO_PHRASES).format(name=name)
    prediction_lines = generate_prediction(name, n, curse)
    final_text = intro + "\n\n" + "\n\n".join(prediction_lines)
    bot.reply_to(message, final_text)


# –†–∞–Ω–¥–æ–º–Ω–æ–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –≤ —á–∞—Ç —Ä–∞–∑ –≤ —á–∞—Å
def schedule_random_prediction(bot, chat_id, users):
    if not users:
        return
    user = random.choice(users)
    fake_message = type("FakeMsg", (), {})()
    fake_message.from_user = user
    fake_message.text = "/say"
    fake_message.chat = type("Chat", (), {"id": chat_id})()
    handle(bot, fake_message)
    # —á–µ—Ä–µ–∑ 1 —á–∞—Å
    threading.Timer(3600, schedule_random_prediction, args=(bot, chat_id, users)).start()