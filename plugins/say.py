# plugins/say.py
import random
from telebot.types import Message

TRIGGER = "/say"

# Ð’ÑÐµ 78 ÐºÐ°Ñ€Ñ‚ Ð¢Ð°Ñ€Ð¾
ALL_CARDS = [
    # Ð¡Ñ‚Ð°Ñ€ÑˆÐ¸Ðµ ÐÑ€ÐºÐ°Ð½Ñ‹
    "Ð”ÑƒÑ€Ð°Ðº", "ÐœÐ°Ð³", "Ð–Ñ€Ð¸Ñ†Ð°", "Ð˜Ð¼Ð¿ÐµÑ€Ð°Ñ‚Ñ€Ð¸Ñ†Ð°", "Ð˜Ð¼Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€", "Ð˜ÐµÑ€Ð¾Ñ„Ð°Ð½Ñ‚", "Ð’Ð»ÑŽÐ±Ð»ÐµÐ½Ð½Ñ‹Ðµ", "ÐšÐ¾Ð»ÐµÑÐ½Ð¸Ñ†Ð°",
    "Ð¡Ð¸Ð»Ð°", "ÐžÑ‚ÑˆÐµÐ»ÑŒÐ½Ð¸Ðº", "ÐšÐ¾Ð»ÐµÑÐ¾ Ð¤Ð¾Ñ€Ñ‚ÑƒÐ½Ñ‹", "Ð¡Ð¿Ñ€Ð°Ð²ÐµÐ´Ð»Ð¸Ð²Ð¾ÑÑ‚ÑŒ", "ÐŸÐ¾Ð²ÐµÑˆÐµÐ½Ð½Ñ‹Ð¹", "Ð¡Ð¼ÐµÑ€Ñ‚ÑŒ",
    "Ð£Ð¼ÐµÑ€ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ", "Ð”ÑŒÑÐ²Ð¾Ð»", "Ð‘Ð°ÑˆÐ½Ñ", "Ð—Ð²ÐµÐ·Ð´Ð°", "Ð›ÑƒÐ½Ð°", "Ð¡Ð¾Ð»Ð½Ñ†Ðµ", "Ð¡ÑƒÐ´", "ÐœÐ¸Ñ€",
    # ÐœÐ»Ð°Ð´ÑˆÐ¸Ðµ ÐÑ€ÐºÐ°Ð½Ñ‹ â€” ÐšÑƒÐ±ÐºÐ¸
    "Ð¢ÑƒÐ· ÐšÑƒÐ±ÐºÐ¾Ð²", "Ð”Ð²Ð¾Ð¹ÐºÐ° ÐšÑƒÐ±ÐºÐ¾Ð²", "Ð¢Ñ€Ð¾Ð¹ÐºÐ° ÐšÑƒÐ±ÐºÐ¾Ð²", "Ð§ÐµÑ‚Ð²ÐµÑ€ÐºÐ° ÐšÑƒÐ±ÐºÐ¾Ð²", "ÐŸÑÑ‚ÐµÑ€ÐºÐ° ÐšÑƒÐ±ÐºÐ¾Ð²", 
    "Ð¨ÐµÑÑ‚ÐµÑ€ÐºÐ° ÐšÑƒÐ±ÐºÐ¾Ð²", "Ð¡ÐµÐ¼ÐµÑ€ÐºÐ° ÐšÑƒÐ±ÐºÐ¾Ð²", "Ð’Ð¾ÑÑŒÐ¼ÐµÑ€ÐºÐ° ÐšÑƒÐ±ÐºÐ¾Ð²", "Ð”ÐµÐ²ÑÑ‚ÐºÐ° ÐšÑƒÐ±ÐºÐ¾Ð²", "Ð”ÐµÑÑÑ‚ÐºÐ° ÐšÑƒÐ±ÐºÐ¾Ð²",
    "ÐŸÐ°Ð¶ ÐšÑƒÐ±ÐºÐ¾Ð²", "Ð Ñ‹Ñ†Ð°Ñ€ÑŒ ÐšÑƒÐ±ÐºÐ¾Ð²", "ÐšÐ¾Ñ€Ð¾Ð»ÐµÐ²Ð° ÐšÑƒÐ±ÐºÐ¾Ð²", "ÐšÐ¾Ñ€Ð¾Ð»ÑŒ ÐšÑƒÐ±ÐºÐ¾Ð²",
    # ÐœÐµÑ‡Ð¸
    "Ð¢ÑƒÐ· ÐœÐµÑ‡ÐµÐ¹", "Ð”Ð²Ð¾Ð¹ÐºÐ° ÐœÐµÑ‡ÐµÐ¹", "Ð¢Ñ€Ð¾Ð¹ÐºÐ° ÐœÐµÑ‡ÐµÐ¹", "Ð§ÐµÑ‚Ð²ÐµÑ€ÐºÐ° ÐœÐµÑ‡ÐµÐ¹", "ÐŸÑÑ‚ÐµÑ€ÐºÐ° ÐœÐµÑ‡ÐµÐ¹", 
    "Ð¨ÐµÑÑ‚ÐµÑ€ÐºÐ° ÐœÐµÑ‡ÐµÐ¹", "Ð¡ÐµÐ¼ÐµÑ€ÐºÐ° ÐœÐµÑ‡ÐµÐ¹", "Ð’Ð¾ÑÑŒÐ¼ÐµÑ€ÐºÐ° ÐœÐµÑ‡ÐµÐ¹", "Ð”ÐµÐ²ÑÑ‚ÐºÐ° ÐœÐµÑ‡ÐµÐ¹", "Ð”ÐµÑÑÑ‚ÐºÐ° ÐœÐµÑ‡ÐµÐ¹",
    "ÐŸÐ°Ð¶ ÐœÐµÑ‡ÐµÐ¹", "Ð Ñ‹Ñ†Ð°Ñ€ÑŒ ÐœÐµÑ‡ÐµÐ¹", "ÐšÐ¾Ñ€Ð¾Ð»ÐµÐ²Ð° ÐœÐµÑ‡ÐµÐ¹", "ÐšÐ¾Ñ€Ð¾Ð»ÑŒ ÐœÐµÑ‡ÐµÐ¹",
    # ÐŸÐµÐ½Ñ‚Ð°ÐºÐ»Ð¸
    "Ð¢ÑƒÐ· ÐŸÐµÐ½Ñ‚Ð°ÐºÐ»ÐµÐ¹", "Ð”Ð²Ð¾Ð¹ÐºÐ° ÐŸÐµÐ½Ñ‚Ð°ÐºÐ»ÐµÐ¹", "Ð¢Ñ€Ð¾Ð¹ÐºÐ° ÐŸÐµÐ½Ñ‚Ð°ÐºÐ»ÐµÐ¹", "Ð§ÐµÑ‚Ð²ÐµÑ€ÐºÐ° ÐŸÐµÐ½Ñ‚Ð°ÐºÐ»ÐµÐ¹", "ÐŸÑÑ‚ÐµÑ€ÐºÐ° ÐŸÐµÐ½Ñ‚Ð°ÐºÐ»ÐµÐ¹",
    "Ð¨ÐµÑÑ‚ÐµÑ€ÐºÐ° ÐŸÐµÐ½Ñ‚Ð°ÐºÐ»ÐµÐ¹", "Ð¡ÐµÐ¼ÐµÑ€ÐºÐ° ÐŸÐµÐ½Ñ‚Ð°ÐºÐ»ÐµÐ¹", "Ð’Ð¾ÑÑŒÐ¼ÐµÑ€ÐºÐ° ÐŸÐµÐ½Ñ‚Ð°ÐºÐ»ÐµÐ¹", "Ð”ÐµÐ²ÑÑ‚ÐºÐ° ÐŸÐµÐ½Ñ‚Ð°ÐºÐ»ÐµÐ¹", "Ð”ÐµÑÑÑ‚ÐºÐ° ÐŸÐµÐ½Ñ‚Ð°ÐºÐ»ÐµÐ¹",
    "ÐŸÐ°Ð¶ ÐŸÐµÐ½Ñ‚Ð°ÐºÐ»ÐµÐ¹", "Ð Ñ‹Ñ†Ð°Ñ€ÑŒ ÐŸÐµÐ½Ñ‚Ð°ÐºÐ»ÐµÐ¹", "ÐšÐ¾Ñ€Ð¾Ð»ÐµÐ²Ð° ÐŸÐµÐ½Ñ‚Ð°ÐºÐ»ÐµÐ¹", "ÐšÐ¾Ñ€Ð¾Ð»ÑŒ ÐŸÐµÐ½Ñ‚Ð°ÐºÐ»ÐµÐ¹",
    # Ð–ÐµÐ·Ð»Ñ‹
    "Ð¢ÑƒÐ· Ð–ÐµÐ·Ð»Ð¾Ð²", "Ð”Ð²Ð¾Ð¹ÐºÐ° Ð–ÐµÐ·Ð»Ð¾Ð²", "Ð¢Ñ€Ð¾Ð¹ÐºÐ° Ð–ÐµÐ·Ð»Ð¾Ð²", "Ð§ÐµÑ‚Ð²ÐµÑ€ÐºÐ° Ð–ÐµÐ·Ð»Ð¾Ð²", "ÐŸÑÑ‚ÐµÑ€ÐºÐ° Ð–ÐµÐ·Ð»Ð¾Ð²",
    "Ð¨ÐµÑÑ‚ÐµÑ€ÐºÐ° Ð–ÐµÐ·Ð»Ð¾Ð²", "Ð¡ÐµÐ¼ÐµÑ€ÐºÐ° Ð–ÐµÐ·Ð»Ð¾Ð²", "Ð’Ð¾ÑÑŒÐ¼ÐµÑ€ÐºÐ° Ð–ÐµÐ·Ð»Ð¾Ð²", "Ð”ÐµÐ²ÑÑ‚ÐºÐ° Ð–ÐµÐ·Ð»Ð¾Ð²", "Ð”ÐµÑÑÑ‚ÐºÐ° Ð–ÐµÐ·Ð»Ð¾Ð²",
    "ÐŸÐ°Ð¶ Ð–ÐµÐ·Ð»Ð¾Ð²", "Ð Ñ‹Ñ†Ð°Ñ€ÑŒ Ð–ÐµÐ·Ð»Ð¾Ð²", "ÐšÐ¾Ñ€Ð¾Ð»ÐµÐ²Ð° Ð–ÐµÐ·Ð»Ð¾Ð²", "ÐšÐ¾Ñ€Ð¾Ð»ÑŒ Ð–ÐµÐ·Ð»Ð¾Ð²",
]

# Ð¡Ð¼Ð°Ð¹Ð»Ñ‹ Ð´Ð»Ñ ÑƒÑÐ¸Ð»ÐµÐ½Ð¸Ñ ÑÑ„Ñ„ÐµÐºÑ‚Ð°
EMOJIS = ["ðŸ”®", "âœ¨", "ðŸŒ™", "ðŸ”¥", "ðŸ•¯ï¸", "ðŸ’€", "ðŸŒŸ", "ðŸ’«", "âš¡", "ðŸ’°"]

# Ð’ÑÑ‚ÑƒÐ¿Ð»ÐµÐ½Ð¸Ñ
START_PHRASES = [
    "ðŸ”® Ð¯ Ð²Ð¸Ð¶Ñƒ, {name}â€¦",
    "âœ¨ ÐšÐ°Ñ€Ñ‚Ñ‹ ÑˆÐµÐ¿Ñ‡ÑƒÑ‚ Ñ‚ÐµÐ±Ðµ, {name}â€¦",
    "ðŸŒ™ Ð¡ÑƒÐ´ÑŒÐ±Ð° Ð¾Ñ‚ÐºÑ€Ñ‹Ð²Ð°ÐµÑ‚ Ð¿ÐµÑ€ÐµÐ´ Ñ‚Ð¾Ð±Ð¾Ð¹ Ð¿ÑƒÑ‚ÑŒ, {name}â€¦",
    "ðŸ”¥ ÐœÐ°Ð³Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ñ€Ð°ÑÐºÐ»Ð°Ð´ Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚, {name}â€¦",
    "ðŸ•¯ï¸ Ð’ Ð²Ð¸Ñ…Ñ€Ðµ ÑÐ½ÐµÑ€Ð³Ð¸Ð¸ Ð²Ð¸Ð¶Ñƒ, {name}â€¦",
]

# ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ð¹ ÐºÐ°Ñ€Ñ‚ â€” Ð¼Ð¾Ð¶Ð½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÑ‚ÑŒ Ð±Ð¾Ð»ÑŒÑˆÐµ ÑˆÐ°Ð±Ð»Ð¾Ð½Ð¾Ð² Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð¹ ÐºÐ°Ñ€Ñ‚Ñ‹
CARD_MEANINGS = {
    "Ð¡Ð¾Ð»Ð½Ñ†Ðµ": [
        "Ð¡Ð¾Ð»Ð½Ñ†Ðµ ÑÐ¸ÑÐµÑ‚ Ð½Ð°Ð´ Ñ‚Ð²Ð¾ÐµÐ¹ Ð¶Ð¸Ð·Ð½ÑŒÑŽ, {name}. Ð­Ñ‚Ð¾ Ð²Ñ€ÐµÐ¼Ñ ÑƒÑÐ¿ÐµÑ…Ð° Ð¸ ÑÑÐ½Ð¾ÑÑ‚Ð¸, Ñ„Ð¸Ð½Ð°Ð½ÑÑ‹ Ð¼Ð¾Ð³ÑƒÑ‚ Ð²Ð½ÐµÐ·Ð°Ð¿Ð½Ð¾ Ð¿Ð¾Ñ€Ð°Ð´Ð¾Ð²Ð°Ñ‚ÑŒ ðŸ’°. Ð‘ÑƒÐ´ÑŒ ÑƒÐ²ÐµÑ€ÐµÐ½ Ð² ÑÐ²Ð¾Ð¸Ñ… Ñ€ÐµÑˆÐµÐ½Ð¸ÑÑ… Ð¸ Ð½Ðµ ÑÐ¾Ð¼Ð½ÐµÐ²Ð°Ð¹ÑÑ Ð² ÑÐµÐ±Ðµ ðŸŒž.",
        "Ð­Ð½ÐµÑ€Ð³Ð¸Ñ Ð¡Ð¾Ð»Ð½Ñ†Ð° Ð±Ð»Ð°Ð³Ð¾Ð²Ð¾Ð»Ð¸Ñ‚ Ñ‚ÐµÐ±Ðµ, {name}. Ð¢Ñ‹ Ð¿Ð¾Ñ‡ÑƒÐ²ÑÑ‚Ð²ÑƒÐµÑˆÑŒ Ð¿Ñ€Ð¸Ð»Ð¸Ð² ÑÐ¸Ð», Ð° Ð»ÑŽÐ´Ð¸ Ð²Ð¾ÐºÑ€ÑƒÐ³ Ð±ÑƒÐ´ÑƒÑ‚ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°Ñ‚ÑŒ Ñ‚ÐµÐ±Ñ ðŸŒŸ."
    ],
    "Ð‘Ð°ÑˆÐ½Ñ": [
        "Ð‘Ð°ÑˆÐ½Ñ Ñ€ÑƒÑˆÐ¸Ñ‚ÑÑ, {name} âš¡. Ð¢ÐµÐºÑƒÑ‰Ð¸Ðµ Ð¿Ð»Ð°Ð½Ñ‹ Ð¼Ð¾Ð³ÑƒÑ‚ Ñ€Ð°Ð·Ñ€ÑƒÑˆÐ¸Ñ‚ÑŒÑÑ, Ð±ÑƒÐ´ÑŒ Ð³Ð¾Ñ‚Ð¾Ð² Ðº Ð½ÐµÐ¾Ð¶Ð¸Ð´Ð°Ð½Ð½Ð¾ÑÑ‚ÑÐ¼. Ð”ÐµÑ€Ð¶Ð¸ÑÑŒ ÐºÑ€ÐµÐ¿ÐºÐ¾ Ð¸ Ð½Ðµ Ð¿Ñ€Ð¸Ð½Ð¸Ð¼Ð°Ð¹ Ð¿Ð¾ÑÐ¿ÐµÑˆÐ½Ñ‹Ñ… Ñ€ÐµÑˆÐµÐ½Ð¸Ð¹ ðŸ’€.",
        "ÐšÐ°Ñ€Ñ‚Ñ‹ Ð¿Ñ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´Ð°ÑŽÑ‚, {name}, ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ Ð¼Ð¾Ð³ÑƒÑ‚ Ð¿Ð¾Ð¹Ñ‚Ð¸ Ð½Ð°Ð¿ÐµÑ€ÐµÐºÐ¾ÑÑÐº. Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐ¹ ÑÐ¿Ð¾ÐºÐ¾Ð¹ÑÑ‚Ð²Ð¸Ðµ Ð¸ Ð¾Ñ†ÐµÐ½Ð¸ ÑÐ¸Ñ‚ÑƒÐ°Ñ†Ð¸ÑŽ ðŸŒªï¸."
    ],
    "ÐŸÐ¾Ð²ÐµÑˆÐµÐ½Ð½Ñ‹Ð¹": [
        "ÐŸÐ¾Ð²ÐµÑˆÐµÐ½Ð½Ñ‹Ð¹ ÑƒÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚ Ð½Ð° Ð¿Ð°ÑƒÐ·Ñƒ, {name}. Ð¡ÐµÐ¹Ñ‡Ð°Ñ Ð½Ðµ Ð²Ñ€ÐµÐ¼Ñ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¾Ð²Ð°Ñ‚ÑŒ, Ð½Ð¾ Ð¼Ð½Ð¾Ð³Ð¾ Ð¼Ð¾Ð¶Ð½Ð¾ Ð¿Ð¾Ð½ÑÑ‚ÑŒ Ð¸ Ð¿ÐµÑ€ÐµÐ¾ÑÐ¼Ñ‹ÑÐ»Ð¸Ñ‚ÑŒ ðŸ•¯ï¸.",
        "Ð­Ð½ÐµÑ€Ð³Ð¸Ñ ÐŸÐ¾Ð²ÐµÑˆÐµÐ½Ð½Ð¾Ð³Ð¾ Ð½Ð°Ð¿Ð¾Ð¼Ð¸Ð½Ð°ÐµÑ‚, {name}, Ñ‡Ñ‚Ð¾ Ð¶ÐµÑ€Ñ‚Ð²Ð° ÑÐµÐ¹Ñ‡Ð°Ñ Ð¿Ñ€Ð¸Ð²ÐµÐ´Ñ‘Ñ‚ Ðº Ð±ÑƒÐ´ÑƒÑ‰Ð¸Ð¼ Ð±Ð»Ð°Ð³Ð°Ð¼ ðŸŒ™."
    ],
    # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÑˆÐ°Ð±Ð»Ð¾Ð½Ñ‹ Ð´Ð»Ñ Ð²ÑÐµÑ… ÐºÐ°Ñ€Ñ‚ Ð¿Ð¾ Ð°Ð½Ð°Ð»Ð¾Ð³Ð¸Ð¸
}

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ð¿Ñ€ÐµÐ´ÑÐºÐ°Ð·Ð°Ð½Ð¸Ñ
def generate_prediction(name, n=3):
    n = max(1, min(n, 10))  # Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡Ð¸Ð²Ð°ÐµÐ¼ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÐºÐ°Ñ€Ñ‚
    cards = random.sample(ALL_CARDS, n)
    intro = random.choice(START_PHRASES).format(name=name)
    
    predictions = []
    for card in cards:
        if card in CARD_MEANINGS:
            predictions.append(random.choice(CARD_MEANINGS[card]).format(name=name))
        else:
            predictions.append(f"{name}, ÐºÐ°Ñ€Ñ‚Ð° {card} Ð½ÐµÑÑ‘Ñ‚ Ñ‚Ð°Ð¹Ð½Ñ‹Ðµ Ð·Ð½Ð°Ð½Ð¸Ñ, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ñ Ð¾ÑÑ‚Ð¾Ñ€Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒÑŽ ðŸŒ€ðŸ’«.")
    
    return intro + "\n\n" + "\n\n".join(predictions)

# ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¸Ð¼ÐµÐ½Ð¸
def get_name(message: Message):
    user = message.from_user
    if user.first_name:
        return user.first_name
    return "Ñ‚Ñ‹"

# ÐžÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /say
def handle(bot, message: Message):
    text = (message.text or "").strip().lower()
    if not text.startswith(TRIGGER):
        return
    
    parts = text.split()
    n = 3  # Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ 3 ÐºÐ°Ñ€Ñ‚Ñ‹
    if len(parts) >= 2:
        try:
            n = int(parts[1])
        except:
            n = 3
    
    name = get_name(message)
    prediction = generate_prediction(name, n)
    bot.reply_to(message, prediction)