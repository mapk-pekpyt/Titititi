# plugins/say.py
import random
from telebot.types import Message

TRIGGER = "/say"

ALL_CARDS = [
    # –°—Ç–∞—Ä—à–∏–µ –ê—Ä–∫–∞–Ω—ã
    "–î—É—Ä–∞–∫", "–ú–∞–≥", "–ñ—Ä–∏—Ü–∞", "–ò–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞", "–ò–º–ø–µ—Ä–∞—Ç–æ—Ä", "–ò–µ—Ä–æ—Ñ–∞–Ω—Ç", "–í–ª—é–±–ª–µ–Ω–Ω—ã–µ", "–ö–æ–ª–µ—Å–Ω–∏—Ü–∞",
    "–°–∏–ª–∞", "–û—Ç—à–µ–ª—å–Ω–∏–∫", "–ö–æ–ª–µ—Å–æ –§–æ—Ä—Ç—É–Ω—ã", "–°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å", "–ü–æ–≤–µ—à–µ–Ω–Ω—ã–π", "–°–º–µ—Ä—Ç—å",
    "–£–º–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å", "–î—å—è–≤–æ–ª", "–ë–∞—à–Ω—è", "–ó–≤–µ–∑–¥–∞", "–õ—É–Ω–∞", "–°–æ–ª–Ω—Ü–µ", "–°—É–¥", "–ú–∏—Ä",
    # –ú–ª–∞–¥—à–∏–µ –ê—Ä–∫–∞–Ω—ã ‚Äî –ö—É–±–∫–∏
    "–¢—É–∑ –ö—É–±–∫–æ–≤", "–î–≤–æ–π–∫–∞ –ö—É–±–∫–æ–≤", "–¢—Ä–æ–π–∫–∞ –ö—É–±–∫–æ–≤", "–ß–µ—Ç–≤–µ—Ä–∫–∞ –ö—É–±–∫–æ–≤", "–ü—è—Ç–µ—Ä–∫–∞ –ö—É–±–∫–æ–≤", 
    "–®–µ—Å—Ç–µ—Ä–∫–∞ –ö—É–±–∫–æ–≤", "–°–µ–º–µ—Ä–∫–∞ –ö—É–±–∫–æ–≤", "–í–æ—Å—å–º–µ—Ä–∫–∞ –ö—É–±–∫–æ–≤", "–î–µ–≤—è—Ç–∫–∞ –ö—É–±–∫–æ–≤", "–î–µ—Å—è—Ç–∫–∞ –ö—É–±–∫–æ–≤",
    "–ü–∞–∂ –ö—É–±–∫–æ–≤", "–†—ã—Ü–∞—Ä—å –ö—É–±–∫–æ–≤", "–ö–æ—Ä–æ–ª–µ–≤–∞ –ö—É–±–∫–æ–≤", "–ö–æ—Ä–æ–ª—å –ö—É–±–∫–æ–≤",
    # –ú–µ—á–∏
    "–¢—É–∑ –ú–µ—á–µ–π", "–î–≤–æ–π–∫–∞ –ú–µ—á–µ–π", "–¢—Ä–æ–π–∫–∞ –ú–µ—á–µ–π", "–ß–µ—Ç–≤–µ—Ä–∫–∞ –ú–µ—á–µ–π", "–ü—è—Ç–µ—Ä–∫–∞ –ú–µ—á–µ–π", 
    "–®–µ—Å—Ç–µ—Ä–∫–∞ –ú–µ—á–µ–π", "–°–µ–º–µ—Ä–∫–∞ –ú–µ—á–µ–π", "–í–æ—Å—å–º–µ—Ä–∫–∞ –ú–µ—á–µ–π", "–î–µ–≤—è—Ç–∫–∞ –ú–µ—á–µ–π", "–î–µ—Å—è—Ç–∫–∞ –ú–µ—á–µ–π",
    "–ü–∞–∂ –ú–µ—á–µ–π", "–†—ã—Ü–∞—Ä—å –ú–µ—á–µ–π", "–ö–æ—Ä–æ–ª–µ–≤–∞ –ú–µ—á–µ–π", "–ö–æ—Ä–æ–ª—å –ú–µ—á–µ–π",
    # –ü–µ–Ω—Ç–∞–∫–ª–∏
    "–¢—É–∑ –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "–î–≤–æ–π–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "–¢—Ä–æ–π–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "–ß–µ—Ç–≤–µ—Ä–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "–ü—è—Ç–µ—Ä–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π",
    "–®–µ—Å—Ç–µ—Ä–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "–°–µ–º–µ—Ä–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "–í–æ—Å—å–º–µ—Ä–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "–î–µ–≤—è—Ç–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "–î–µ—Å—è—Ç–∫–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π",
    "–ü–∞–∂ –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "–†—ã—Ü–∞—Ä—å –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "–ö–æ—Ä–æ–ª–µ–≤–∞ –ü–µ–Ω—Ç–∞–∫–ª–µ–π", "–ö–æ—Ä–æ–ª—å –ü–µ–Ω—Ç–∞–∫–ª–µ–π",
    # –ñ–µ–∑–ª—ã
    "–¢—É–∑ –ñ–µ–∑–ª–æ–≤", "–î–≤–æ–π–∫–∞ –ñ–µ–∑–ª–æ–≤", "–¢—Ä–æ–π–∫–∞ –ñ–µ–∑–ª–æ–≤", "–ß–µ—Ç–≤–µ—Ä–∫–∞ –ñ–µ–∑–ª–æ–≤", "–ü—è—Ç–µ—Ä–∫–∞ –ñ–µ–∑–ª–æ–≤",
    "–®–µ—Å—Ç–µ—Ä–∫–∞ –ñ–µ–∑–ª–æ–≤", "–°–µ–º–µ—Ä–∫–∞ –ñ–µ–∑–ª–æ–≤", "–í–æ—Å—å–º–µ—Ä–∫–∞ –ñ–µ–∑–ª–æ–≤", "–î–µ–≤—è—Ç–∫–∞ –ñ–µ–∑–ª–æ–≤", "–î–µ—Å—è—Ç–∫–∞ –ñ–µ–∑–ª–æ–≤",
    "–ü–∞–∂ –ñ–µ–∑–ª–æ–≤", "–†—ã—Ü–∞—Ä—å –ñ–µ–∑–ª–æ–≤", "–ö–æ—Ä–æ–ª–µ–≤–∞ –ñ–µ–∑–ª–æ–≤", "–ö–æ—Ä–æ–ª—å –ñ–µ–∑–ª–æ–≤",
]

# –°–º–∞–π–ª—ã –¥–ª—è –∫–∞—Ä—Ç
CARD_EMOJIS = ["üîÆ", "‚ú®", "üåô", "üî•", "üïØÔ∏è", "üíÄ", "üåü", "üí´", "‚ö°", "üí∞", "üå™Ô∏è", "üåä", "üå∏", "üçÄ"]

# –í—Å—Ç—É–ø–ª–µ–Ω–∏—è
INTRO_PHRASES = [
    "üîÆ –Ø –≤–∏–∂—É, {name}‚Ä¶",
    "‚ú® –ö–∞—Ä—Ç—ã —à–µ–ø—á—É—Ç —Ç–µ–±–µ, {name}‚Ä¶",
    "üåô –°—É–¥—å–±–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø–µ—Ä–µ–¥ —Ç–æ–±–æ–π –ø—É—Ç—å, {name}‚Ä¶",
    "üî• –ú–∞–≥–∏—á–µ—Å–∫–∏–π —Ä–∞—Å–∫–ª–∞–¥ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, {name}‚Ä¶",
    "üïØÔ∏è –í–∏—Ö—Ä—å —ç–Ω–µ—Ä–≥–∏–∏ –ø—Ä–∏–Ω–æ—Å–∏—Ç –ø–æ—Å–ª–∞–Ω–∏–µ, {name}‚Ä¶",
]

# –ü–æ–¥—ã—Ç–æ–≥–æ–≤—ã–µ —Ñ—Ä–∞–∑—ã
CONCLUSION_PHRASES = [
    "üåü –û–±—â–µ–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ: –±—É–¥—å –≤–Ω–∏–º–∞—Ç–µ–ª–µ–Ω –∫ –æ–∫—Ä—É–∂–∞—é—â–∏–º, —Å–ª–µ–¥—É–π –∏–Ω—Ç—É–∏—Ü–∏–∏ –∏ –∏–∑–±–µ–≥–∞–π —Å–ø–µ—à–∫–∏.",
    "üí´ –ò—Ç–æ–≥ —Ä–∞—Å–∫–ª–∞–¥–∞: —Ç–≤–æ—è —ç–Ω–µ—Ä–≥–∏—è —Å–µ–π—á–∞—Å –Ω–∞ –ø–æ–¥—ä—ë–º–µ, –Ω–æ –Ω–µ –∑–∞–±—ã–≤–∞–π –ø—Ä–æ –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å.",
    "‚ö° –ó–∞–∫–ª—é—á–µ–Ω–∏–µ: —Å–∏—Ç—É–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω—á–∏–≤–∞, –¥–µ–π—Å—Ç–≤—É–π –º—É–¥—Ä–æ –∏ —Å–æ—Ö—Ä–∞–Ω—è–π —Ç–µ—Ä–ø–µ–Ω–∏–µ.",
]

# –ü–æ—Ä—á–∞ –∫–∞—Ä—Ç—ã
CURSE_CARDS = [
    "–ü–æ—Ä—á–∞: –°–≥–ª–∞–∑ üíÄ", "–ü–æ—Ä—á–∞: –ë–æ–ª–µ–∑–Ω—å üï∑Ô∏è", "–ü–æ—Ä—á–∞: –ù–µ–≤–µ–∑–µ–Ω–∏–µ üå™Ô∏è", "–ü–æ—Ä—á–∞: –†–∞–∑–ª–∞–¥ üî•", "–ü–æ—Ä—á–∞: –°—Å–æ—Ä–∞ ‚ö°"
]

# –ó–Ω–∞—á–µ–Ω–∏—è –∫–∞—Ä—Ç ‚Äî –ø—Ä–∏–º–µ—Ä—ã
CARD_MEANINGS = {
    "–°–æ–ª–Ω—Ü–µ": ["–°–æ–ª–Ω—Ü–µ —Å–∏—è–µ—Ç –Ω–∞–¥ —Ç–≤–æ–µ–π –∂–∏–∑–Ω—å—é. –≠—Ç–æ –≤—Ä–µ–º—è —É—Å–ø–µ—Ö–∞ –∏ —è—Å–Ω–æ—Å—Ç–∏, —Ñ–∏–Ω–∞–Ω—Å—ã –º–æ–≥—É—Ç –≤–Ω–µ–∑–∞–ø–Ω–æ –ø–æ—Ä–∞–¥–æ–≤–∞—Ç—å üí∞. –ë—É–¥—å —É–≤–µ—Ä–µ–Ω –≤ —Ä–µ—à–µ–Ω–∏—è—Ö –∏ –Ω–µ —Å–æ–º–Ω–µ–≤–∞–π—Å—è –≤ —Å–µ–±–µ üåû."],
    "–ë–∞—à–Ω—è": ["–ë–∞—à–Ω—è –ø–∞–¥–∞–µ—Ç ‚ö°. –¢–µ–∫—É—â–∏–µ –ø–ª–∞–Ω—ã –º–æ–≥—É—Ç —Ä–∞–∑—Ä—É—à–∏—Ç—å—Å—è, –±—É–¥—å –≥–æ—Ç–æ–≤ –∫ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ—Å—Ç—è–º –∏ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—é."],
    "–ü–æ–≤–µ—à–µ–Ω–Ω—ã–π": ["–ü–æ–≤–µ—à–µ–Ω–Ω—ã–π —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –ø–∞—É–∑—É. –°–µ–π—á–∞—Å –Ω–µ –≤—Ä–µ–º—è –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å, –Ω–æ –º–Ω–æ–≥–æ –º–æ–∂–Ω–æ –ø–æ–Ω—è—Ç—å –∏ –ø–µ—Ä–µ–æ—Å–º—ã—Å–ª–∏—Ç—å. –¢–≤–æ—è —Å–∏–ª–∞ –≤ —Ç–µ—Ä–ø–µ–Ω–∏–∏ üïØÔ∏è."],
    "–¢—É–∑ –ñ–µ–∑–ª–æ–≤": ["–¢—É–∑ –ñ–µ–∑–ª–æ–≤ –Ω–µ—Å—ë—Ç –º–æ—â–Ω—É—é —ç–Ω–µ—Ä–≥–∏—é –Ω–æ–≤–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞. –î–µ–π—Å—Ç–≤—É–π —Ä–µ—à–∏—Ç–µ–ª—å–Ω–æ, –Ω–æ —Å —É–º–æ–º üî•."],
    "–î–µ–≤—è—Ç–∫–∞ –ö—É–±–∫–æ–≤": ["–î–µ–≤—è—Ç–∫–∞ –ö—É–±–∫–æ–≤ –≥–æ–≤–æ—Ä–∏—Ç –æ —Ä–∞–¥–æ—Å—Ç–∏ –∏ —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–∏. –°–æ–±—ã—Ç–∏—è –ø–æ—Ä–∞–¥—É—é—Ç, –Ω–æ –ø–æ–º–Ω–∏ –ø—Ä–æ –±–∞–ª–∞–Ω—Å üéâ."],
    # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –∫–∞—Ä—Ç –¥–ª—è –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏
}

# –ü–æ–ª—É—á–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
def get_name(message: Message):
    if message.from_user.first_name:
        return message.from_user.first_name
    return "—Ç—ã"

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–∞—Å–∫–ª–∞–¥–∞
def generate_prediction(name, n=3, curse=False):
    n = max(1, min(n, 10))
    prediction_lines = []
    
    if curse:
        card = random.choice(CURSE_CARDS)
        prediction_lines.append(f"üíÄ –í–Ω–∏–º–∞–Ω–∏–µ! {card} –Ω–∞ —Ç–µ–±—è –Ω–∞–≤–µ–ª–∏. –ë–µ—Ä–µ–≥–∏ —Å–µ–±—è!")
        return prediction_lines

    cards = random.sample(ALL_CARDS, n)
    
    for card in cards:
        text = random.choice(CARD_MEANINGS.get(card, [f"–ö–∞—Ä—Ç–∞ {card} –Ω–µ—Å—ë—Ç —Ç–∞–π–Ω—ã–µ –∑–Ω–∞–Ω–∏—è, –∏—Å–ø–æ–ª—å–∑—É–π —Å –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å—é üåÄ."]))
        emoji = random.choice(CARD_EMOJIS)
        prediction_lines.append(f"{emoji} {text}")
    
    # –ü–æ–¥—ã—Ç–æ–≥
    conclusion = random.choice(CONCLUSION_PHRASES)
    prediction_lines.append(conclusion)
    
    return prediction_lines

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã
def handle(bot, message: Message):
    text = (message.text or "").strip().lower()
    if not text.startswith(TRIGGER):
        return
    
    parts = text.split()
    n = 3
    curse = False
    for part in parts[1:]:
        if part.isdigit():
            n = int(part)
        elif "–ø–æ—Ä—á–∞" in part:
            curse = True
    
    name = get_name(message)
    intro = random.choice(INTRO_PHRASES).format(name=name)
    
    prediction_lines = generate_prediction(name, n, curse)
    final_text = intro + "\n\n" + "\n\n".join(prediction_lines)
    
    bot.reply_to(message, final_text)